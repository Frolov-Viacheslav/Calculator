#!groovy
//properties([disableConcurrentBuilds()])

pipeline {
  agent{
    label 'master'
  }
 options {
    timestamps()
  }
  stages {
    stage('Build app') {
      steps {
        sh '''
            if  [ -d HelloWorld ]; then
            rm -r HelloWorld
            fi
            git clone "git@github.com:Frolov-Viacheslav/Calculator.git" --branch dev
            ansible-playbook Calculator/Ansible/playbook.yml
            rm -r Calculator
            
           '''
      }
    }
    stage('Copy jar') {
         steps {
             script {
                 step ([$class: 'CopyArtifact',
                 projectName: 'Calculator',
                 filter: "target/Calculator*.jar",
                 target: 'Test_copy_artifact']);
             }
         }
  }
  post { 
        // Выполняет в конце сборки (если сборка не удалась)
        failure { 
            sh '''
            if  [ -d Calculator ]; then
            rm -r Calculator
            fi
            git clone "git@github.com:Frolov-Viacheslav/Calculator.git" --branch dev
            cd Calculator
            git reset --hard HEAD~
            git push -f
            cd ..
            rm -r Calculator
            '''

    emailext (
      subject: "FAILURE: ${env.JOB_NAME} Build # ${env.BUILD_NUMBER} ",
      body: """FAILED: Job ${env.JOB_NAME} [${env.BUILD_NUMBER}]'. Your last commit has been canceled: ${env.GIT_COMMIT}.
      Check console output at: ${env.BUILD_URL}console
      """,
      to: 'v.frolov@csn.khai.edu',
      from: 'slava.frolov777@gmail.com',
      recipientProviders: [[$class: 'DevelopersRecipientProvider']]
    )
        }
    // Выполнит, если сборка удалась
    success{
      
    emailext (
      subject: "SUCCESS: ${env.JOB_NAME} Build # ${env.BUILD_NUMBER} ",
      body: """SUCCESS: Job ${env.JOB_NAME} [${env.BUILD_NUMBER}]':
      Check console output at: ${env.BUILD_URL}console
      """,
      to: 'v.frolov@csn.khai.edu',
      from: 'slava.frolov777@gmail.com',
      recipientProviders: [[$class: 'DevelopersRecipientProvider']]
    )
        }
    }
}
